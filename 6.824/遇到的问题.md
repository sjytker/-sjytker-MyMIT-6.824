## json.NewEncoder 无法写入文件

**解决**：

​	struct 可导出性的问题，必须 uppercase 开头的变量才是可导出的，才能被写入 json 文件



## rpc 调用找不到 master 的函数

**问题**：

​	我在 master 写了 2 个 rpc 调用函数，其中一个能正常调用。另一个报错找不到该方法。调用方式完全一致，并且 master 也确定有 worker 调用的同名函数。

​	（搞了半天才找到问题）

**解决**：

​	还是 Golang exported 类型的问题。无论是 type，还是参数，都只有 uppercase 开头才是 exported，否则 unexported。

​	在 unexported 的情况下，文件不能写入，rpc 也无法调用。



## Mutex 的问题

**问题***：

​	习惯了 Java 的可重入锁，没意识到 golang 的 mutex 是不可重入的



## 共享变量问题

由于每个 Raft 对象既发送，又接收，它的对象变量是共享的，所有访问到共享变量的函数都应该加锁。否则会出现并发问题。



## Election 忙等

​	一开始我用 waitGroup（效果与 Java CountDownLatch 相同）等待所有 server 返回 RequestVote 结果。忽略了如果此时有 server down 无法选出 leader 的问题。

​	加上 time.Timer 来计时，timeout 则退出



## TestB 偶尔出现 fail to reach agreement

- 这个错误捣鼓了几天。有时出现报错，有时又能 pass all test
- 最大的困难是，问题不可重现。多个测试函数都有概率出现。
- 最后，通过阅读所有测试代码 config 类，了解测试流程，得知是 RequestVote 选 leader 的逻辑没有写对



## TestB 经常出现 applied error

- 检查了很久代码逻辑，发现 raft 算法的 RequestVote 和 AppendEntries 应该都没有写错
- 注意到这个报错的函数 command list 很长，再结合阅读测试代码，猜测应该是 AE 逐步回退太慢了。遂采用优化的，低时间复杂度的方法



## 有低概率 failTest（hard)

- 由于存在很多随机的 timeout，所以一次测试成功 pass 不能代表永远能 pass。
- 用一个脚本自动跑 100 次 lab2ABC test（共 >20 个不同情况的 test，每做完所有算 1 次），30% 概率 fail，这些 fail 的日志很奇怪，看上去附近的代码没逻辑错误，但打出的日志仔细看规律，其实并不对。找了很久，发现同时存在两个 leader。导致测试脚本有时把 cmd 放到了 leader1，有时放到了 leader2
- 这种情况可能存在于：第一个 leader down 了，过了一段时间后 rejoin，此时有两个 leader，但是我在 AE 中，只有 reply.success = true 才让接受者强制转为 follower。改为任何情况下都转为 follower。
- 更改后，还是有极低概率 failTest。并且在本机 (4 核 16 G) 5% 概率 fail，服务器 (10 核 64 G) 1% 概率 fail。有时候日志会出现 no leader 的错误，猜测是本机资源短缺，造成多次 split vote 选不出 leader，超出了测试时间。
- 根据 Raft paper 作者所述，实际中不会经历这么频繁且恶劣的 server down，所以有些优化甚至意义不大。总的来说，100次恶劣测试失败 1 次的概率，也算可以了。









